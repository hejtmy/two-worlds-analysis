---
title: "Transfer report"
author: "Lukáš 'hejtmy' Hejtmánek"
date: "4 June 2018"
output: github_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(ez)
library(Hmisc)
library(knitr)
library(dplyr)
library(reshape2)
library(broom)
library(brainvr.R)
library(xtable)
library(restimoter)
library(papaja)
library(googlesheets)


source("../Scripts/paper-prepare.R")

source("helpers/block-t-test-improvement.R")
source("helpers/block-t-test.R")
source("helpers/block-measure.R")
source("helpers/block-correlation.R")


settings <- load_google_sheets()
df_participants <- settings$participants
df_participants <- df_participants %>% mutate(condition=paste0(First.phase,"-",Second.phase))
df_participants <- df_participants %>% filter(condition %in% c("vr-real", "real-real", "ve-real"))
overview <- settings$versions
overview <- overview %>% mutate(condition=paste0(First.phase,"-",Second.phase))
overview <- overview %>% filter(condition %in% c("vr-real", "real-real", "ve-real"))

#green, violet, blue, yellow, pink, dark blue
estimote_pal <- c('#b6d6c1', '#54003d','#93d5f6','#d5d215','#f3aacb','#2d2556')
theme_set(theme_minimal())

### Try running it without outliers
sub_walk_all[!is.na(sub_walk_all$norm_distance) & sub_walk_all$norm_distance > 3, c("distance", "min_norm_distance")] <- NA

condition_all_sums <- sub_walk_all %>% 
  group_by(exp_block_id, id, learning.condition) %>% 
  summarise(sum.distance = sum(min_norm_distance, na.rm = T), 
            sum.errors = sum(errors, na.rm = T),
            mean.distance = mean(min_norm_distance, na.rm = T),
            mean.error = mean(errors, na.rm = T))

df_errors <- block_measure(condition_all_sums, "sum.errors")
df_distance <- block_measure(condition_all_sums, "mean.distance")

df_wide_errors <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "sum.errors")
df_wide_distance <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "mean.distance")
colnames(df_wide_errors) <- c("learning.condition","id","block1", "block2","block3","block4","block5","block6")
colnames(df_wide_distance) <- c("learning.condition","id","block1", "block2","block3","block4","block5","block6")
df_wide_errors$block34 <- (df_wide_errors$block3-df_wide_errors$block4)/(df_wide_errors$block3+df_wide_errors$block4)
df_wide_distance$block34 <- (df_wide_distance$block3-df_wide_distance$block4)/(df_wide_distance$block3+df_wide_distance$block4)

sub_walk_all_factor <- sub_walk_all
sub_walk_all_factor$exp_block_id <- factor(sub_walk_all_factor$exp_block_id)
sub_walk_all_factor$id <- factor(sub_walk_all_factor$id)
sub_walk_all_factor$learning.condition <- factor(sub_walk_all_factor$learning.condition)

knitr::opts_chunk$set(echo=F, warning = F, message = F)
```

## Per phase separation
```{r warning=F, echo=F}
make_graph(sub_walk_all, "learning.condition", "distance", "phase") + 
  ylab("Average absolute trial distance") + xlab("condition") + 
  scale_fill_manual(values=estimote_pal,"Phase")

make_graph(sub_walk_all, "learning.condition", "min_norm_distance", "phase") + 
  ylab("Average normalised trial distance") + xlab("condition") + 
  scale_fill_manual(values=estimote_pal,"Phase")

make_graph(sub_walk_all, "learning.condition", "time", "phase") + 
  ylab("Average absolute trial duration") + xlab("condition") + 
  scale_fill_manual(values=estimote_pal,"Phase")

make_graph(sub_walk_all, "learning.condition", "min_norm_time", "phase")+ 
  ylab("Average normalised trial duration") + xlab("condition") + 
  scale_fill_manual(values=estimote_pal, "Phase")

make_graph(sub_walk_all, "learning.condition", "errors", "phase")+ 
  ylab("Average number of errors") + xlab("condition") + 
  scale_fill_manual(values=estimote_pal,"Phase")
```

## PER BLOCK
```{r warning=F, echo=F}
make_graph(walk_all, "learning.condition", "distance", "exp_block_id") + 
  ylab("Average absolute trial distance") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F)

make_graph(sub_walk_all, "learning.condition", "min_norm_distance", "exp_block_id") + 
  ylab("Average normalised trial distance") +  xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F)

make_graph(sub_walk_all, "learning.condition", "time", "exp_block_id") + 
  ylab("Average absolute trial duration") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F)

make_graph(sub_walk_all, "learning.condition", "min_norm_time", "exp_block_id") + 
  ylab("Average normalised trial duration") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F)

make_graph(sub_walk_all, "learning.condition", "errors", "exp_block_id")+ 
  ylab("Average number of errors") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F)

ggplot(sub_walk_all, aes(x = exp_block_id, y = min_norm_distance, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Average normalised trial distance") + xlab("Block") + 
  scale_color_manual(values=estimote_pal,"Condition") + guides(fill=F)

ggplot(sub_walk_all, aes(x = exp_trial_id, y = min_norm_distance, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  geom_vline(xintercept = 18.5, linetype=4) +
  ylab("Average normalised trial distance") + xlab("Block number") + 
  scale_color_manual(values=estimote_pal, "Condition")

ggplot(sub_walk_all, aes(x = exp_block_id, y = errors, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Number of mistakes in office decision") + xlab("Block number") + 
  scale_color_manual(values=estimote_pal, "Condition")

ggplot(walk_all, aes(x = exp_block_id, y = min_norm_distance, color = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Average normalised trial distance") + xlab("Block") + 
  scale_color_manual(values=estimote_pal,"Condition") + guides(fill=F)

ggplot(walk_all, aes(x = exp_block_id, y = errors, color = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Average visitation errors") + xlab("Block") + 
  scale_color_manual(values=estimote_pal,"Condition") + guides(fill=F)

```

## Pointing
```{r warning=F, echo=F, message=F}
ggplot(sop_all, aes(x = condition, y = abs(error), fill=factor(phase))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average pointing error in degrees") + xlab("Condition") + 
  scale_fill_manual(values = estimote_pal, "Phase")

ggplot(sop_all, aes(x = phase, y = abs(error), color = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal, size=1, width = 0.1, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 2, geom="line") + 
  ylab("Average pointing error in degrees") + xlab("Phase") + 
  scale_color_manual(values = estimote_pal, "Learning condition")

```
## Sum of errors

Measure of overall sum of errors. Mean columns define mean sum of errors for all participants in that block
```{r, echo=F, warnings = F}
df <- block_measure(condition_all_sums, "sum.errors")
kable(df)
ggplot(melt(df[,1:4]), aes(x = learning.condition, y = value, fill = variable)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  scale_fill_manual(values = estimote_pal) +
  ylab("Mean sum of errors") + xlab("Learning condition")  + guides(fill=F)

ggplot(df, aes(x = learning.condition, y = block34.diff, fill = learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block34.diff-block34.se, ymax=block34.diff+block34.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Mean sum of errors improvement after switch")+ xlab("Learning condition") + guides(fill=F)

ggplot(df, aes(x = learning.condition, y = block14.diff, fill = learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block14.diff-block14.se, ymax=block14.diff+block14.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Mean sum of errors improvement from block 1 to 4") + xlab("Learning condition")  + guides(fill=F)
```

## Normalised distance

Measure of mean distance. First three columns define mean normalised distance in each block.
```{r, echo=F, warnings = F}
df <- block_measure(condition_all_sums, "mean.distance")
kable(df)
ggplot(melt(df[,1:4]), aes(x = learning.condition, y = value, fill = variable)) + 
  scale_fill_manual(values = estimote_pal) +
  geom_bar(stat = 'identity', position="dodge") + ylab("Mean normalised distance")

ggplot(df, aes(x = learning.condition, y = block34.diff, fill = learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block34.diff-block34.se, ymax=block34.diff+block34.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Mean normalised distance improvement from block 3 to 4") + xlab("Learning condition")  + guides(fill=F)

ggplot(df, aes(x = learning.condition, y = block14.diff, fill = learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block14.diff-block14.se, ymax=block14.diff+block14.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Mean normalised distance improvement from block 1 to 4") + xlab("Learning condition")  + guides(fill=F)
```

# Stats

## Block T tests
Paired block comparisons for improvement in different condiutions
```{r, echo=F}
block_t_test <- function(df, block1, block2, value){
  df <- df %>% filter(exp_block_id %in% c(block1,block2))
  mean.na <- function(data){return(mean(data, na.rm = T))}
  df_wide <- dcast(df, condition + id ~ exp_block_id, value.var = value, fun.aggregate = mean.na)
  colnames(df_wide) <- c("condition","id", "block1","block2")
  df_wide %>% group_by(condition) %>% do(tidy(t.test(.$block1, .$block2, paired = T)))
}
```

### Block 1-4
Paired t tests between min normalised distance difference in blocks 1 and 4.
```{r, echo=F}
kable(block_t_test(sub_walk_all, 3, 1,"min_norm_distance"))
```
And for number of errors
```{r, echo=F}
kable(block_t_test(sub_walk_all, 3, 1,"errors"))
```



### Block 3-4
Paired t tests between min normalised distance difference in blocks 3 and 4.
```{r, echo=F}
kable(block_t_test(sub_walk_all, 4, 3,"min_norm_distance"))
```

And for number of errors
```{r, echo=F}
kable(block_t_test(sub_walk_all, 4, 3,"errors"))
```

### Block 1-4
Paired t tests between min normalised distance difference in blocks 1 and 4.
```{r, echo=F}
kable(block_t_test(sub_walk_all, 4, 1,"min_norm_distance"))
```
And for number of errors
```{r, echo=F}
kable(block_t_test(sub_walk_all, 4, 1,"errors"))
```

### Block 1-6
Paired t tests between min normalised distance difference in blocks 1 and 6.

```{r, echo=F}
kable(block_t_test(sub_walk_all, 6, 1,"min_norm_distance"))
```

And for number of errors

```{r, echo=F}
kable(block_t_test(sub_walk_all, 6, 1,"errors"))
```

## Independent block improvement comparisons between conditions for distance
```{r, echo=F}
report_independent_comparisons <- function(df_wide, column){
  desktop_real <- t.test(df_wide[df_wide$learning.condition=="Desktop", column],df_wide[df_wide$learning.condition=="Real", column])
  treadmill_real <- t.test(df_wide[df_wide$learning.condition=="Treadmill VR", column],df_wide[df_wide$learning.condition=="Real", column])  
  treadmill_desktop <- t.test(df_wide[df_wide$learning.condition=="Treadmill VR", column],df_wide[df_wide$learning.condition=="Desktop", column])
  results <- list(desktop_real, treadmill_real, treadmill_desktop)
  df <- data.frame(`Comparison`=c("Desktop - real", "Treadmil - real", "Treadmil- Desktop"), mean.first=sapply(results, function(x){x$estimate[1]}), mean.second=sapply(results, function(x){x$estimate[2]}), `p-value`=sapply(results, function(x){x$p.value}))
  return(df)
}
```

```{r, echo=F}
df_wide <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "mean.distance")
colnames(df_wide) <- c("learning.condition","id", "block1","block2","block3","block4","block5","block6")
df_wide$diff41 <- (df_wide$block4-df_wide$block1)/(df_wide$block1+df_wide$block3)
df_wide$diff43<- (df_wide$block4-df_wide$block3)/(df_wide$block4+df_wide$block3)
```

### Block 1-4 improvement
```{r, echo=F}
kable(report_independent_comparisons(df_wide, "diff41"))
```

### Block 3-4 improvement
```{r, echo=F}
kable(report_independent_comparisons(df_wide, "diff43"))
```

## Independent block improvement comparisons between conditions for number of errors

```{r, echo=F}
df_wide <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "sum.errors")
colnames(df_wide) <- c("learning.condition", "id", "block1", "block2", "block3", "block4", "block5", "block6")
df_wide$diff41 <- (df_wide$block4-df_wide$block1)/(df_wide$block1+df_wide$block3)
df_wide$diff43<- (df_wide$block4-df_wide$block3)/(df_wide$block4+df_wide$block3)
```

### Block 1-4 improvement
```{r, echo=F}
kable(report_independent_comparisons(df_wide, "diff41"))
```

### Block 3-4 improvement
```{r, echo=F}
kable(report_independent_comparisons(df_wide, "diff43"))
```

## Anova
Simple between subjects anova
```{r, echo=F}
aov_block_distance <- aov(min_norm_distance~exp_block_id*learning.condition, sub_walk_all)
kable(anova_table(aov_block_distance))
```

```{r, echo=F}
ez_prepare_block <- function(df, blocks){
  filtered_data <- df[df$exp_block_id %in% blocks, ]
  filtered_data <- filtered_data[complete.cases(filtered_data),]
  has_all <- filtered_data %>% group_by(id) %>% select(id, "exp_block_id") %>% unique() %>% count
  has_all <- has_all %>% filter(n == 2)
  filtered_data <- filtered_data %>% filter(id %in% has_all$id)
  filtered_data$exp_block_id <- factor(filtered_data$exp_block_id)
  return(filtered_data)
}

clean_walk_14 <- ez_prepare_block(sub_walk_all, c(1,4))
clean_walk_34 <- ez_prepare_block(sub_walk_all, c(3,4))
```

### Normalised distance

Within subjects anova for block 3-4 difference.

```{r, warning = F, echo=F, message=F}
aov_block_dist_34 <- ezANOVA(
  data = clean_walk_34,
  dv = min_norm_distance, 
  wid = id,
  within = exp_block_id,
  between = learning.condition, 
  type = 3)

kable(aov_block_dist_34)

ggplot(clean_walk_34, aes(x = as.numeric(exp_block_id), y = min_norm_distance, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  ylab("Average normalised distance") + xlab("Experimental block") + scale_fill_discrete("Condition")
```

Within subjects anova for block 1-4 difference in minimal path.

```{r, warning = F, echo=F, message=F}
aov_block_dist_14 <- ezANOVA(
  data = clean_walk_14,
  dv = min_norm_distance, 
  wid = id,
  within = exp_block_id,
  between = learning.condition,
  type = 3)

kable(aov_block_dist_14)

ggplot(clean_walk_14, aes(x = as.numeric(exp_block_id), y = min_norm_distance, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  ylab("Average normalised distance") + xlab("Experimental block") + scale_fill_discrete("Condition")
```

### Number of errors
Within subjects anova for block 1-4 number of errors.

```{r, warning = F, echo=F, message=F}
aov_block_err_14 <- ezANOVA(
  data = clean_walk_14,
  dv = errors, 
  wid = id,
  within = exp_block_id,
  between = learning.condition,
  type = 3)

kable(aov_block_err_14)

ggplot(clean_walk_14, aes(x = as.numeric(exp_block_id), y = errors, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  ylab("Average number of errors") + xlab("Experimental block") + scale_fill_discrete("Condition")
```

Within subjects anova for block 3-4 number of errors.
```{r, warning = F, echo=F, message=F}
aov_block_err_34 <- ezANOVA(
  data = clean_walk_34,
  dv = errors, 
  wid = id,
  within = exp_block_id,
  between = condition,
  type = 3)

kable(aov_block_err_34)

ggplot(clean_walk_34, aes(x = as.numeric(exp_block_id), y = errors, color = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line") + 
  ylab("Average number of errors") + xlab("Experimental block") + scale_fill_discrete("Condition")
```


## Office specific learning
```{r, warning=F}
df_corr_err <- data.frame(learning.condition=c("Desktop", "Real", "Treadmill VR"), stringsAsFactors = F)
df_corr_dist <- data.frame(learning.condition=c("Desktop", "Real", "Treadmill VR"), stringsAsFactors = F)
for(i in 1:5){
  df_err <- block_correlation(sub_walk_all, i,i+1, "errors", learning.condition + id + goal ~ exp_block_id, columns=c("learning.condition","id", "goal"))
  colnames(df_err) <- c("learning.condition", paste0("block", i+1))
  df_corr_err <- merge(df_corr_err, data.frame(df_err), by="learning.condition")
  
  df_dist <- block_correlation(sub_walk_all, i,i+1, "min_norm_distance", learning.condition + id + goal ~ exp_block_id, columns=c("learning.condition","id", "goal"))
  colnames(df_dist) <- c("learning.condition", paste0("block", i+1))
  df_corr_dist <- merge(df_corr_dist, data.frame(df_dist), by="learning.condition")
}
df_corr_err
df_corr_dist
```
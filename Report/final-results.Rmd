---
title: "Transfer report"
author: "Lukáš Hejtmánek"
date: "9 August 2018"
output: github_document
---

```{r setup, include=FALSE}
#needs lme and car in the top because of the recode
library(car)
library(lme4)
library(lmerTest)
library(ggplot2)
library(gridExtra)
library(ez)
library(Hmisc)
library(dplyr)
library(reshape2)
library(broom)
library(knitr)
library(papaja)
library(googlesheets)

source("../Scripts/paper-prepare.R")
source("helpers/block-t-test-improvement.R")
source("helpers/block-t-test.R")
source("helpers/block-measure.R")
source("../TwoWorlds/helpers-report.R")

settings <- load_google_sheets()
df_participants <- settings$participants
df_participants <- df_participants %>% mutate(condition=paste0(First.phase,"-",Second.phase))
df_participants <- df_participants %>% filter(condition %in% c("vr-real", "real-real", "ve-real"))
overview <- settings$versions
overview <- overview %>% mutate(condition=paste0(First.phase,"-",Second.phase))
overview <- overview %>% filter(condition %in% c("vr-real", "real-real", "ve-real"))

#green, violet, blue, yellow, pink, dark blue
estimote_pal <- c('#b6d6c1', '#54003d','#93d5f6','#d5d215','#f3aacb','#2d2556')
theme_set(theme_minimal() + theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16)))

### Try running it without outliers
sub_walk_all[!is.na(sub_walk_all$norm_distance) & sub_walk_all$norm_distance > 3, c("distance", "min_norm_distance")] <- NA
walk_all[!is.na(walk_all$norm_distance) & walk_all$norm_distance > 3, c("distance", "min_norm_distance")] <- NA

condition_all_sums <- sub_walk_all %>% 
  group_by(exp_block_id, id, learning.condition) %>% 
  summarise(sum.distance = sum(min_norm_distance, na.rm = T), 
            sum.errors = sum(errors, na.rm = T),
            mean.distance = mean(min_norm_distance, na.rm = T),
            mean.error = mean(errors, na.rm = T))

df_errors <- block_measure(condition_all_sums, "sum.errors")
df_distance <- block_measure(condition_all_sums, "mean.distance")
df_distance$graph.learning.condition <- dplyr::recode(df_distance$learning.condition, "Real" = "Real-world", "Treadmill VR" = "Immersive VR")
df_errors$graph.learning.condition <- dplyr::recode(df_errors$learning.condition, "Real" = "Real-world", "Treadmill VR" = "Immersive VR")


df_wide_errors <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "sum.errors")
df_wide_distance <- dcast(condition_all_sums, learning.condition + id ~ exp_block_id, value.var = "mean.distance")
colnames(df_wide_errors) <- c("learning.condition","id","block1", "block2","block3","block4","block5","block6")
colnames(df_wide_distance) <- c("learning.condition","id","block1", "block2","block3","block4","block5","block6")
df_wide_distance$graph.learning.condition <- dplyr::recode(df_wide_distance$learning.condition, "Real" = "Real-world", "Treadmill VR" = "Immersive VR")
df_wide_errors$graph.learning.condition <- dplyr::recode(df_wide_errors$learning.condition, "Real" = "Real-world", "Treadmill VR" = "Immersive VR")

df_wide_errors$block34 <- (df_wide_errors$block3-df_wide_errors$block4)/(df_wide_errors$block3+df_wide_errors$block4)
df_wide_distance$block34 <- (df_wide_distance$block3-df_wide_distance$block4)/(df_wide_distance$block3+df_wide_distance$block4)

sub_walk_all_factor <- sub_walk_all
sub_walk_all_factor$exp_block_id <- factor(sub_walk_all_factor$exp_block_id)
sub_walk_all_factor$id <- factor(sub_walk_all_factor$id)
sub_walk_all_factor$learning.condition <- factor(sub_walk_all_factor$learning.condition)

knitr::opts_chunk$set(echo=F, warning = F, message = F)
```

## Participants
```{r}
# need revising 
# is_ok == data well measured
# finished == did finsih, regardless of potentially missing real world data
finished <- overview %>% group_by(condition) %>% count(finished)
finished <- dcast(finished, condition~finished)
finished$percent <- round(finished$yes/(finished$yes+finished$no), 2)
is_ok <- overview %>% filter(finished=="yes") %>% group_by(condition) %>% count(is_ok)
is_ok <- dcast(is_ok, condition~is_ok)
is_ok$percent <- round(is_ok$yes/(is_ok$yes+is_ok$no), 2)
```
A total of `r sum(overview$is_ok == "yes", na.rm=T) + sum(finished$no)` undergraduate students at UC Davis (M = `r round(mean(df_participants[df_participants$finished == "yes",]$age, na.rm=T),1)`, SD = `r round(sd(df_participants[df_participants$finished == "yes",]$age, na.rm=T), 1)`) particiapted in the study in exchange for a study credit. `r sum(finished$no)` participants didn't finish due to motion sickness and `r sum(is_ok$no)` were removed due to a technical failure of the real world tracking systen. Only `r finished[finished$condition == "vr-real","percent"] * 100` percent the students being able to finish Treadmill VR learning condition. 

```{r}
ez_data<- ez_prepare_block(sub_walk_all_factor, c(1,4), 'min_norm_distance')
fit_mm_dist_block <- lmer(min_norm_distance ~ learning.condition*exp_block_id + (1 | id), data = ez_data)
ez_fit_distance <- ezANOVA(ez_data, 
        dv = min_norm_distance,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

ez_data <- ez_prepare_block(sub_walk_all_factor, c(1,4), 'errors')
ez_fit_errors <- ezANOVA(ez_data, 
        dv = errors,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

```

We hypothesized that the degree of transfer to the real-world building would vary as a function of immersion. As a first test of this issue, we wished to determine whether all modalities resulted in some degree of transfer. Data for distance walked and number of door visitation errors were each entered into a 3 (Learning Condition: real, desktop, treadmill VR) × 2 (Block: block 1, block 4) mixed-model analysis of variance (ANOVA). For distance walked, there was a main effect for Learning Condition, `r apa_print(ez_fit_distance$aov)$statistic$learning_condition`. There was a also a main effect for Block, `r apa_print(ez_fit_distance$aov)$statistic$exp_block_id`. The Learning Condition by Block interaction effect did not reach significance `r apa_print(ez_fit_distance$aov)$statistic$learning_condition_exp_block_id`. Follow-up comparisons showed that for walked distance all three modalities showed an improvement from block 1 (first exposure to the modality) to block 4 (first exposure to the real building for immersed/impoverished conditions, fourth exposure for real-world). Descriptive and inferential statistics for these comparisons are shown in Table X and Table X+1 for distance and errors, respectively.

For visitation errors, there was no main effect for Learning Condition,`r apa_print(ez_fit_errors$aov)$statistic$learning_condition`. There was a main effect for Block, `r apa_print(ez_fit_errors$aov)$statistic$exp_block_id`. The Learning Condition by Block interaction effect did not reach significance, `r apa_print(ez_fit_errors$aov)$statistic$learning_condition_exp_block_id`. Follow-up comparisons showed that all three modalities showed an improvement in visitation errors from block 1 (first exposure to the modality) to block 4 (first exposure to the real building for immersed/impoverished conditions, fourth exposure for real-world). Descriptive and inferential statistics for these comparisons are shown in Table X+1.

```{r}
#descriptive table
kable(sub_walk_all_factor %>% filter(exp_block_id %in% c(1,4)) %>% group_by(learning.condition, exp_block_id) %>% summarise(M = mean(min_norm_distance, na.rm=T),
                                                                                                                     Sd = sd(min_norm_distance, na.rm=T)), digits = 2)
df_dist <- block_t_test_improvement(sub_walk_all, 1, 4,"min_norm_distance")
df <- block_t_test_improvement_report(df_dist)
df$condition <- dplyr::recode(df$condition, "real-real" = "Real", "ve-real" = "Desktop", "vr-real" = "Treadmill VR", "real-vr" = "Real", "vr-vr" = "Treadmill VR")
kable(df, caption="Paired T test comparing individual distance performance improvement from the first block to post-switch block", digits = 2)

kable(sub_walk_all_factor %>% filter(exp_block_id %in% c(1,4)) %>% group_by(learning.condition, exp_block_id) %>% summarise(M = mean(errors, na.rm=T),
                                                                                                                     Sd = sd(errors, na.rm=T)), digits = 2)
df_error <- block_t_test_improvement(sub_walk_all, 1, 4,"errors")
df <- block_t_test_improvement_report(df_error)
df$condition <- dplyr::recode(df$condition, "real-real" = "Real", "ve-real" = "Desktop", "vr-real" = "Treadmill VR", "real-vr" = "Real", "vr-vr" = "Treadmill VR")
kable(df, caption="Paired T test comparing individual error rate improvement from the first block to post-switch block", digits = 2)
```

Figure X shows the time course of each learning condition over the 6 blocks of exposure to the environments, in terms of walked distance and visitation errors over the course of the experiment.  As can be seen in Figure XX, all modalities showed an incremental improvement in terms of both distance and visitation errors (see fig. XXX and fig. XXX). At block 4, however, an uptick can be observed for the desktop modality switch group and slight for no modality switch (i.e. real to real).  
To better quantify these effects, we took two different approaches. First, we analyzed the slope of the learning curves from phase 1 (blocks 1-3) and compared between different Learning Conditions.

```{r}
### graphs
ggplot(sub_walk_all, aes(x = exp_block_id, y = min_norm_distance, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.5, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1.25, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Average normalised trial distance") + xlab("Block") + 
  scale_color_manual(values=estimote_pal,"Learning condition") + guides(fill=F)

ggplot(sub_walk_all, aes(x = exp_block_id, y = errors, color = factor(learning.condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.5, geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1.25, geom="line") + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Visitation errors") + xlab("Block number") + 
  scale_color_manual(values=estimote_pal, "Learning condition")
```

Figure X. Performance of each learning condition across time is shown for average normalized distance (a) and visitation errors (b). Vertical, dashed line indicates when the second phase of testing (always in the real world) began. Error bars represent [95% CI’s].

## Quantifying what happens before transfer
To better understand the effect of modality (i.e., real world vs. treadmill VR vs. desktop), we assessed the change in walked distance and visitation errors prior to transfer from block 1 to block 3. 

```{r}
ez_data <- ez_prepare_block(sub_walk_all_factor, c(1,3), 'min_norm_distance')
fit_mm_dist_block <- lmer(min_norm_distance ~ learning.condition*exp_block_id + (1 | id/exp_block_id), data = only_blocks(sub_walk_all, c(1,3)))
ez_fit_distance <- ezANOVA(
        ez_data, 
        dv = min_norm_distance,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

ez_data <- ez_prepare_block(sub_walk_all_factor, c(1,3), 'errors')
ez_fit_errors <- ezANOVA(
        ez_data, 
        dv = errors,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)
```

3x2 repeated measures ANOVA revealed a main effect of block on distance performance, suggesting that participants improved their paths in all three conditions, `r apa_print(ez_fit_distance$aov)$statistic$exp_block_id`. The interaction effect with modality was not significant , `r apa_print(ez_fit_distance$aov)$statistic$learning_condition_exp_block_id`, suggesting that learning rate did not differ as a function of modality. In contrast, for visitation errors, we again found a main effect of block (`r apa_print(ez_fit_errors$aov)$statistic$exp_block_id`) but, importantly, a block X modality interaction effect, `r apa_print(ez_fit_errors$aov)$statistic$learning_condition_exp_block_id`. This finding suggested that visitation errors improved differently as a function of modality.

To investigate further, we conducted separate one-way ANOVAs to compare learning conditions for walked distance and visitation errors for the last block of learning (block 3). There were main effects of learning condition for both walked distance, `r apa_print(aov(min_norm_distance ~ learning.condition, only_blocks(sub_walk_all, 3)))$statistic`, and visitation errors, `r  apa_print(aov(errors ~ learning.condition, only_blocks(sub_walk_all, 3)))$statistic`). Comparing the conditions closer, we find that there is a significant difference in visitations error performance between real world and desktop learning (`r apa_print(t.test(errors ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Real', 'Desktop'), 3)))$statistic`) and real world nad treadmill VR learning (`r apa_print(t.test(errors ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Real', 'Treadmill VR'), 3)))$statistic`), but no difference between Desktop and Treadmill learning (`r apa_print(t.test(errors ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Desktop', 'Treadmill VR'), 3)))$statistic`). The situation is the same for distance comparisons. real world and desktop learning (`r apa_print(t.test(min_norm_distance ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Real', 'Desktop'), 3)))$statistic`) and real world nad treadmill VR learning (`r apa_print(t.test(min_norm_distance ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Real', 'Treadmill VR'), 3)))$statistic`), but no difference between Desktop and Treadmill learning (`r apa_print(t.test(min_norm_distance ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Desktop', 'Treadmill VR'), 3)))$statistic`).

```{r}
point_data_1 <- sub_sop_all[sub_sop_all$phase == 1,]
aov_point_phase1 <- aov(abs_error ~ learning.condition, data = point_data_1)
```

We also observed significant differences between conditions in pointing performance at the end of the first phase, `r apa_print(aov_point_phase1)$statistic$learning_condition`.  Specifically, participants in the real-world learning group  (`r m_sd_report(only_conditions(point_data_1, "Real")$abs_error)`) performed significantly better compared to both the immersive VR group (`r m_sd_report(only_conditions(point_data_1, "Treadmill VR")$abs_error)`), `r apa_print(t.test(abs_error ~ learning.condition, only_conditions(point_data_1, c('Real', 'Treadmill VR'))))$statistic`, and the desktop group (`r m_sd_report(only_conditions(point_data_1, "Desktop")$abs_error)`), `r apa_print(t.test(abs_error ~ learning.condition, only_conditions(point_data_1, c('Real', 'Desktop'))))$statistic`. Overall, these findings suggested that participants learned the building the best as a result of real-world navigation, followed by the immersive condition, with the desktop condition showing the slowest acquisition.

```{r}
# Pre transfer plot of normalised distances
ggplot(only_blocks(sub_walk_all_factor, 1:3), aes(x = graph.exp_block_id, y = min_norm_distance, fill = graph.exp_block_id)) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average normalised trial distance") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F) +
  facet_wrap(~graph.learning.condition, strip.position = "bottom", scales = "free_x") + 
  theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside")

ggplot(only_blocks(sub_walk_all_factor, 1:3), aes(x = graph.exp_block_id, y = errors, fill = graph.exp_block_id)) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average visitation errors") + xlab("Learning condition") + 
  scale_fill_manual(values=estimote_pal,"Block") + guides(fill=F) +
  facet_wrap(~graph.learning.condition, strip.position = "bottom", scales = "free_x") + 
  theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside")

ggplot(point_data_1, aes(x = graph.learning.condition, y = abs_error, fill = graph.learning.condition)) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average pointing error after learning phase") + xlab("Learning condition") + 
  scale_fill_manual(values = estimote_pal, "Learning condition") +
  guides(fill=F) + theme(axis.title.y = element_text(size = rel(0.9)))

```


## Quantifying what happens after/during? transfer
```{r}
ez_data <- ez_prepare_block(sub_walk_all_factor, c(3,4), 'min_norm_distance')
fit_mm_dist_block <- lmer(min_norm_distance ~ learning.condition*exp_block_id + (1 | id/exp_block_id), data = only_blocks(sub_walk_all, 3:4))
ez_fit_distance <- ezANOVA(
        ez_data, 
        dv = min_norm_distance,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

ez_data <- ez_prepare_block(sub_walk_all_factor, c(3,4), 'errors')
ez_fit_errors <- ezANOVA(
        ez_data, 
        dv = errors,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)
```

We next considered the effects of transferring from either the treadmill or desktop to the real-world building compared with continuing to navigate the real-world building. We did this by directly comparing walked distance and visitation errors on block 3 (the last block before the transfer phase) with the first block of the transfer phase (block 4). Data for distance walked and number of door visitation errors were each entered into a 3 (Learning Condition: real, desktop, treadmill VR) × 2 (Block: block 1, block 4) mixed-model ANOVA. For visitation errors, there was a main effect for Learning Condition,`r apa_print(ez_fit_errors$aov)$statistic$learning_condition`. There was a main effect for Block, `r apa_print(ez_fit_errors$aov)$statistic$exp_block_id`. The Learning Condition by Block interaction effect was significant, `r apa_print(ez_fit_errors$aov)$statistic$learning_condition_exp_block_id`. For walked distance, there was a main effect of Learning Condition,`r apa_print(ez_fit_distance$aov)$statistic$learning_condition`, but no effect of Block, `r apa_print(ez_fit_distance$aov)$statistic$exp_block_id`, and the interaction also failed to reach significance, `r apa_print(ez_fit_distance$aov)$statistic$learning_condition_exp_block_id`.

To better understand these differences, we ran separate pairwise t-tests to assess the change from block 3 (last block of learning phase) to block 4 (first block of transfer phase). For distance, we found no significant differences from block 3 (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Real", 3)$min_norm_distance)`) to block 4 (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Real", 4)$min_norm_distance)`) for the real-world learning condition, `r apa_print(t.test(min_norm_distance ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Real'), 3:4)))$statistic`. Similarly, there was no difference between block 3 (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Treadmill VR", 3)$min_norm_distance)`) and block 4 (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Treadmill VR", 4)$min_norm_distance)`) for the treadmill VR condition, `r apa_print(t.test(min_norm_distance ~ exp_block_id, only_conditions_blocks(sub_walk_all, 'Treadmill VR', 3:4)))$statistic`. For visitation errors, we found an improvement in all conditions, although the effects sizes were greater for the treadmill compared to the desktop conditions.  Together, these findings suggested that participants maintained or improved for both distance and visitation errors, although these effects were generally smaller, and even tending toward being worse, for the desktop condition. For summary please see table XXX.

```{r}
#descriptive table
kable(sub_walk_all_factor %>% filter(exp_block_id %in% c(3,4)) %>% group_by(learning.condition, exp_block_id) %>% summarise(M = mean(min_norm_distance, na.rm=T),
                                                                                                                     Sd = sd(min_norm_distance, na.rm=T)), digits = 2)
df_dist <- block_t_test_improvement(sub_walk_all_factor, 3, 4,"min_norm_distance")
df <- block_t_test_improvement_report(df_dist)
df$condition <- dplyr::recode(df$condition, "real-real" = "Real", "ve-real" = "Desktop", "vr-real" = "Treadmill VR", "real-vr" = "Real", "vr-vr" = "Treadmill VR")
kable(df, caption="Paired T test comparing individual distance performance improvement from pre switch block to post-switch block", digits = 2)

kable(sub_walk_all_factor %>% filter(exp_block_id %in% c(3,4)) %>% group_by(learning.condition, exp_block_id) %>% summarise(M = mean(errors, na.rm=T),
                                                                                                                     Sd = sd(errors, na.rm=T)), digits = 2)
df_error <- block_t_test_improvement(sub_walk_all_factor, 3, 4, "errors")
df <- block_t_test_improvement_report(df_error)
df$condition <- dplyr::recode(df$condition, "real-real" = "Real", "ve-real" = "Desktop", "vr-real" = "Treadmill VR", "real-vr" = "Real", "vr-vr" = "Treadmill VR")
kable(df, caption="Paired T test comparing individual error rate improvement from pre switch block to post-switch block", digits = 2)
```

## Quantifying transfer 
To assess the level of performance change form directly before and after the switch, we calculated percent improvement score as
(pre-switch performance - post-switch performance)/(pre-switch performance + post-switch performance)
This allowed us to directly compare the relative improvement or deterioration from pre-switch block to the post-switch one.  These findings are shown in Figure XX for normalized distance (Figure XXa) and visitation errors (Figure XXb).

```{r, echo=F}
ggplot(df_distance, aes(x = graph.learning.condition, y = block34.diff, fill = graph.learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block34.diff-block34.se, ymax=block34.diff+block34.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Level of transfer for normalised distance") + 
  xlab("Learning condition") + guides(fill=F) + 
  theme(axis.title.y = element_text(size = rel(0.9)))

ggplot(df_errors, aes(x = graph.learning.condition, y = block34.diff, fill = graph.learning.condition)) + 
  geom_bar(stat = 'identity', position="dodge") + 
  geom_errorbar(aes(ymin=block34.diff-block34.se, ymax=block34.diff+block34.se), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = estimote_pal) +
  ylab("Level of transfer for visitation errors")+ xlab("Learning condition") + 
  guides(fill=F) + theme(axis.title.y = element_text(size = rel(0.9)))
```

Comparing the improvement in walked distance using one-way ANOVA, we see did not find any  significant difference between groups `r apa_print(aov(block34 ~ learning.condition, df_wide_distance))$statistic$learning_condition `. Visual inspection of the data, however, suggested that the desktop condition again showed the least transfer from block 3 to block 4. For visitation errors, there were significant group differences in error rate improvement, `r apa_print(aov(block34 ~ learning.condition, df_wide_errors))$statistic$learning_condition`. Comparing the conditions pairwise, we can asses that there is a significant difference in improvement between real world learnign and desktop (`r apa_print(t.test(block34 ~ learning.condition, only_conditions(df_wide_errors, c('Real', 'Desktop'))))$statistic`), as well as Treadmill VR, `r apa_print(t.test(block34 ~ learning.condition, only_conditions(df_wide_errors, c('Real', 'Treadmill VR'))))$statistic`, but we find no difference in improvement betweem desktop learning and Treadmill VR learning, `r apa_print(t.test(block34 ~ learning.condition, only_conditions(df_wide_errors, c('Treadmill VR', 'Desktop'))))$statistic`.

Together, these findings suggest that transfer from desktop to real-world environments resulted in an increase in visitation errors, while no change was present for immersive and real-world conditions.

## Quantifying what happens after transfer

```{r}
ez_data <- ez_prepare_block(sub_walk_all_factor, c(4,6), 'min_norm_distance')
fit_mm_dist_block <- lmer(min_norm_distance ~ learning.condition*exp_block_id + (1 | id/exp_block_id), data = only_blocks(sub_walk_all, c(4,6)))
ez_fit_distance <- ezANOVA(
        ez_data, 
        dv = min_norm_distance,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

ez_data <- ez_prepare_block(sub_walk_all_factor, c(4,6), 'errors')
ez_fit_errors <- ezANOVA(
        ez_data, 
        dv = errors,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)
```

As an additional assay of transfer, we wished to determine whether learning post modality switch was faster in the group that had been exposed to the real-world in the learning blocks compared to the VR groups. Comparing walked distance and visitation errors across between blocks 4 and 6 by running repeated measures ANOVA, we found a significant effect of learning condition on distance,`r apa_print(ez_fit_distance$aov)$statistic$learning_condition` and visitation errors `r apa_print(ez_fit_errors$aov)$statistic$learning_condition`. We also wound significant interaction effect between learning condition and block for both distance `r apa_print(ez_fit_distance$aov)$statistic$learning_condition` and visitation errors `r apa_print(ez_fit_errors$aov)$statistic$learning_condition`.

Looking at the improvement in visitations errors from block 4 to block 6 in separate learning conditions using t-tests, we can assess that only Desktop group (`r apa_print(t.test(errors ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Desktop'), c(4,6))))$statistic`) and Treadmill VR group (`r apa_print(t.test(errors ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Treadmill VR'), c(4,6))))$statistic`) have improved, whereas group learned in the real world did not improve any more in the transfer phase (`r apa_print(t.test(errors ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Real'), c(4,6))))$statistic`). 

The story is similar with distance performance, with both Desktop (`r apa_print(t.test(min_norm_distance ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Desktop'), c(4,6))))$statistic`) and Treadmill VR (`r apa_print(t.test(min_norm_distance ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Treadmill VR'), c(4,6))))$statistic`) improve from the 4th to the 6th block, but so does the real world learning group (`r apa_print(t.test(min_norm_distance ~ exp_block_id, only_conditions_blocks(sub_walk_all, c('Real'), c(4,6))))$statistic`).

In the last testing block (block 6), we found no differences among the groups in either error rate (`r apa_print(aov(errors ~ learning.condition, only_blocks(sub_walk_all, 6)))$statistic`), nor pointing performance (`r apa_print(aov(abs_error ~ learning.condition, data = sub_sop_all[sub_sop_all$phase == 2,]))$statistic$learning_condition`). However we still see small difference in distance performance (`r apa_print(aov(min_norm_distance ~ learning.condition, only_blocks(sub_walk_all, 6)))$statistic`), with real group (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Real", 6)$min_norm_distance)`) performing better than Treadmill VR group (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Treadmill VR", 6)$min_norm_distance)`)(`r apa_print(t.test(min_norm_distance ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Treadmill VR', 'Real'), 6)))$statistic`) and desktop group (`r m_sd_report(only_conditions_blocks(sub_walk_all, "Desktop", 6)$min_norm_distance)`)(`r apa_print(t.test(min_norm_distance ~ learning.condition, only_conditions_blocks(sub_walk_all, c('Real', 'Desktop'), 6)))$statistic`).

## Could effects be driven by difficulty with the immersive interface?

To attempt to address this issue, we compared the three different modalities, navigating in the real-world (real-world), navigating on the treadmill with the head-mounted display (immersed), and navigating with a joystick in desktop VR (impoverished) on the first block of the experiment.  Comparing normalized distances, there were no difference between (`r apa_print(aov(min_norm_distance ~ learning.condition, only_blocks(sub_walk_all, 1)))$statistic$learning_condition`), nor in visitation errors (`r apa_print(aov(errors ~ learning.condition, only_blocks(sub_walk_all, 1)))$statistic$learning_condition`).  This suggests that participants were readily able to navigate in the different modalities regardless of the interface.  We did, however, find a significant difference in normalized time (`r apa_print(aov(min_norm_time ~ learning.condition, only_blocks(sub_walk_all, 1)))$statistic$learning_condition`). This effect appeared to be driven largely by the fact that treadmill VR participants took to get used to the interface and therefore having longer trial times at the start.  

## Experiment 1b: Comparing transfer from desktop to real and treadmill to desktop
```{r}
### Try running it without outliers
sub_walk_all_2[!is.na(sub_walk_all_2$norm_distance) & sub_walk_all_2$norm_distance > 3, c("distance", "min_norm_distance")] <- NA

sub_walk_all_2_factor <- sub_walk_all_2
sub_walk_all_2_factor$exp_block_id <- factor(sub_walk_all_2_factor$exp_block_id)
sub_walk_all_2_factor$id <- factor(sub_walk_all_2_factor$id)
sub_walk_all_2_factor$learning.condition <- factor(sub_walk_all_2_factor$learning.condition)
```

Based on our findings above, we might predict that transferring knowledge from desktop to the real world was most difficult for subjects, with the immersive group somewhere in between. We also found, that despite the groups differ at the end of the learning phase, their performance is the same after three blocks in the transfer phase. It is unclear, whether this equalisation of performance is solely due to exposure to the real world, and wihout it participants could never perform perfectly, or if the tradmill VR modality could achieve the same performance as the real world training, but it only needs more time. 

To test this idea, we added two more conditions. One group learned the UC Center for Neuroscience building on the treadmill VR while the second group learned in the real world, but both were tested in the tradmill VR in the transfer phase. This allowed us to assess if the treadmill VR can achieve the same performance given additional time and also investigate the process of opposite transfer.

### Participants
```{r}
df_participants <- settings$participants
df_participants <- df_participants %>% mutate(condition=paste0(First.phase,"-",Second.phase))
df_participants <- df_participants %>% filter(condition %in% c("real-vr", "vr-vr"))
overview <- settings$versions
overview <- overview %>% mutate(condition=paste0(First.phase,"-",Second.phase))
overview <- overview %>% filter(condition %in% c("real-vr", "vr-vr"))
all_participant <- df_participants %>% left_join(overview, by="Code")

finished <- overview %>% group_by(condition) %>% count(finished)
finished <- dcast(finished, condition~finished)
finished$percent <- round(finished$yes/(finished$yes+finished$no), 2)
is_ok <- overview %>% filter(finished=="yes") %>% group_by(condition) %>% count(is_ok)
is_ok <- dcast(is_ok, condition~is_ok)
is_ok$percent <- round(is_ok$yes/(is_ok$yes+is_ok$no), 2)
```
A total of `r sum(overview$is_ok == "yes", na.rm=T) + sum(finished$no)` undergraduate students at UC Davis particiapted in the second experiment. `r sum(finished$no)` participants didn't finish due to motion sickness and `r sum(is_ok$no, na.rm=T)` were removed due to a technical failure of the real world tracking system. Analyses were then conducted on a final set of `r sum(overview$is_ok == "yes", na.rm=T) ` (14 female) with mean age of `r round(mean(all_participant[all_participant$is_ok == "yes",]$age, na.rm=T),1)` (SD = `r round(sd(all_participant[all_participant$is_ok == "yes",]$age, na.rm=T), 1)`).

```{r}
kable(finished)
all_participant %>% filter(is_ok=="yes") %>% group_by(sex) %>% count(sex)
```

## Quantifying performance in the last block
First we assessed difference between the two learning conditions in the last block performance usint t-tests. The conditions did not differ in the walking performance (`r apa_print(t.test(min_norm_distance ~ learning.condition, only_blocks(sub_walk_all_2, c(6))))$statistic`) nor visiting errors (`r apa_print(t.test(errors ~ learning.condition, only_blocks(sub_walk_all_2, c(6))))$statistic`), therefore showing that both treadmill VR and real world learning leads to the same performance in the VR.


## Comparing to previous conditions
Running a one-way ANOVA togeher together with other conditions from the first experiment (real to real, Vr - real and desktop to real), shows a significant effect of condition on final walking performance (`r apa_print(aov(min_norm_distance ~ condition, only_blocks(walk_all, c(6))))$statistic`).

```{r}
kable(tukey_report_table(TukeyHSD(aov(min_norm_distance ~ condition, only_blocks(walk_all, c(6))))))
```

Looking at the final walking performance in the Table XXX, we can see that the differences between conditions are truly negligible. Interestingly, we found no significant difference between the conditions when we analysed absolute distance, rather than normalised (`r apa_print(aov(distance ~ condition, only_blocks(walk_all, c(6))))$statistic`). This means that all aprticipants walked the same distance in the end on average, regardless of them being tested on a treadmill or in the real building. We also found no difference between any of the conditions in their final pointing performance, `r apa_print(aov(abs_error ~ condition, sop_all[sop_all$phase==2,]))$statistic`.

```{r}
df <- only_blocks(walk_all, c(6)) %>% group_by(condition) %>% summarize(dist = m_sd_report(min_norm_distance), errors= m_sd_report(errors))
kable(df, caption='Average performance in all conditions in the last block in visitation errors and walking disntace', digits=2)
```

A different story is in comparing the visitation errors across conditions in the last block, where one-way ANOVA shows significant difference (`r apa_print(aov(errors ~ condition, only_blocks(walk_all, c(6))))$statistic`) and Tukey's post hoc tests demonstrates significant differences between all conditions that differs in transfer phase modality, e.g. participants in the real world always perform better than participants on the treadmill VR. Looking at the table XXX, we can clearly see that conditions with transfer phase happening in VR, despite having comparable walked distance, have higher number of visitation errors. We think that this may have emerged from two different sources: firstly, it can point to higher difficulty in recognizing proper doors because of lesser visual accuracy in the VR, where all doors look similar unlike real doors which may demonstrate unique signs of wear or use. The second reason for the increased number of visitation errors in VR conditions can be explained by the lesser "social impact" of wrong choice. Whereas in the real conditions, participants had to actively inquire the experimenter, there was technically no penalty for "trying out" wrong door in the VR.

```{r, fig.width=10, fig.height=8}
ggplot(walk_all, aes(x = exp_block_id, y = min_norm_distance, group = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(width=0.1), width = 0.2, geom="errorbar", aes(color=graph.learning.condition, linetype=testing.condition)) + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line", aes(color=graph.learning.condition, linetype=testing.condition)) + 
  geom_vline(xintercept = 3.5, linetype=4) + 
  ylab("Average normalised trial distance") + xlab("Block") + 
  scale_color_manual(values=estimote_pal, "Learning condition") + 
  scale_linetype_manual(values=c("dashed", "solid"), "Transfer condition") + 
  guides(fill=F)

ggplot(walk_all, aes(x = exp_block_id, y = errors, color = factor(condition))) +
  stat_summary(fun.data=mean_cl_normal, position=position_dodge(width=0.1), width = 0.2, geom="errorbar", aes(color=graph.learning.condition, linetype=testing.condition)) + 
  stat_summary(fun.y=mean,position=position_identity(), size = 1, geom="line", aes(color=graph.learning.condition, linetype=testing.condition)) + 
  geom_vline(xintercept = 3.5, linetype=4) +
  ylab("Average number of visitation errors") + xlab("Block") + 
  scale_color_manual(values=estimote_pal, "Learning condition") + 
  scale_linetype_manual(values=c("dashed", "solid"), "Transfer condition") + 
  guides(fill=F)
```

### Quantifying transfer
```{r}
ez_data <- ez_prepare_block(sub_walk_all_2_factor, c(3,4), 'min_norm_distance')
fit_mm_dist_block <- lmer(min_norm_distance ~ learning.condition*exp_block_id + (1 | id/exp_block_id), data = only_blocks(sub_walk_all, 3:4))
ez_fit_distance <- ezANOVA(
        ez_data, 
        dv = min_norm_distance,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)

ez_data <- ez_prepare_block(sub_walk_all_factor, c(3,4), 'errors')
ez_fit_errors <- ezANOVA(
        ez_data, 
        dv = errors,
        wid = id,
        within = exp_block_id,
        between = learning.condition,
        return_aov = T,
        type = 3)
```

Assessing the effects of trasfering from the real world to the Treadmill VR, we ran 2 (Learning condition: real vs treadmill VR) x 2 (block 3 vs blcok 4) ANOVA on data for distance walked and visitation errors. There was no effect of block `r apa_print(ez_fit_distance$aov)$statistic$exp_block_id` nor learning condition (`r apa_print(ez_fit_distance$aov)$statistic$learning_condition`) on distance walked and we observed no interaction effects (`r apa_print(ez_fit_distance$aov)$statistic$learning_condition_exp_block_id`). But we found significant interaction effect between block and learning condition in visitation errors, `r apa_print(ez_fit_errors$aov)$statistic$learning_condition_exp_block_id`. 

Pairwise t-tests comparing change in error rate from 3rd to 4th block show, that the group learning on the treadmill VR does show significant difference (`r apa_print(t.test(errors ~ exp_block_id, only_conditions_blocks(sub_walk_all_2, 'Treadmill VR', 3:4)))$statistic`) as it effectively didn't change the environment, but the group switching to the VR from the real world demonstrates increase in visitations errors from block 3 (`r m_sd_report(only_conditions_blocks(sub_walk_all_2, "Real", 3)$errors)`) to block 4 (`r m_sd_report(only_conditions_blocks(sub_walk_all_2, "Real", 4)$errors)`), `r apa_print(t.test(errors ~ exp_block_id, only_conditions_blocks(sub_walk_all_2, 'Real', 3:4)))$statistic`.

```{r, fig.width=10, fig.height=8}
ggplot(only_blocks(walk_all, 6), aes(x = testing.condition, y = min_norm_distance, fill = graph.learning.condition)) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average path distance in the last block of the transfer phase") + xlab("Transfer condition") + 
  scale_fill_manual(values = estimote_pal, "Condition")  + guides(fill=F) + 
  facet_wrap(~graph.learning.condition, strip.position = "top", scales = "free_x") + 
  ggtitle("Learning condition")+
  theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside",
         strip.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5))

ggplot(only_blocks(walk_all, 6), aes(x = testing.condition, y = errors, fill = graph.learning.condition)) +
  stat_summary(fun.data=mean_cl_normal,position=position_dodge(0.95), geom="errorbar") + 
  stat_summary(fun.y=mean,position=position_dodge(width=0.95),geom="bar") +
  ylab("Average number of visitation errors in the last block of the transfer phase") + xlab("Transfer condition") + 
  scale_fill_manual(values = estimote_pal, "Condition")  + guides(fill=F) + 
  facet_wrap(~graph.learning.condition, strip.position = "top", scales = "free_x") + 
  ggtitle("Learning condition")+
  theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside",
         strip.text = element_text(size = 16),
          plot.title = element_text(hjust = 0.5))
```

### Summary
In the last block, all conditios perform similarly as far as the walking distance goes, regardless of them being tested on the VR or in the real building. VR leads to overall higher error rates, but same walking performance, even when considering absolute distances. There are no significant differences in pointing performance between conditions, regardless of pointing being tested in the real world or in the VR.
